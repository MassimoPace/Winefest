<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Secret Draw ‚Äî Country & Style</title>
<style>
  :root{
    --bg:#0f1221; --card:#171a2b; --ink:#e9ecff; --muted:#aab0d6; --accent:#7aa2ff; --accent-2:#9ef0c3; --danger:#ff6b6b;
    --radius:14px; --radius-sm:10px; --shadow: 0 10px 30px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.05) inset;
  }
  body{
    margin:0; font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    color:var(--ink); background:radial-gradient(1000px 600px at 20% -10%, #1b2150 0%, transparent 60%),
                       radial-gradient(800px 500px at 100% 0%, #1a3e34 0%, transparent 60%), var(--bg);
    display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .wrap{width:min(980px,100%); display:grid; gap:18px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:22px;
  }
  .title{font-size:24px; font-weight:700; margin:0 0 6px}
  .subtitle{color:var(--muted); margin:0 0 14px}
  textarea,input{width:100%; padding:12px 14px; border-radius:var(--radius-sm); border:1px solid rgba(255,255,255,.08);
    background:#111426; color:var(--ink); outline:none}
  textarea{min-height:120px; resize:vertical}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .btn{padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer; border:0;
    background:linear-gradient(90deg, var(--accent) 0%, #9d8cff 100%); color:#0b0f20}
  .btn.secondary{background:#202546; color:var(--ink); border:1px solid rgba(255,255,255,.1)}
  .copy{padding:8px 10px; border-radius:10px; background:#0f1430; color:var(--ink); border:1px solid rgba(255,255,255,.12); cursor:pointer}
  .list{display:grid; gap:10px}
  .link-item{display:flex; align-items:center; gap:12px; padding:12px; border-radius:10px; background:#12162c; border:1px dashed rgba(255,255,255,.12)}
  .tip{color:var(--muted); font-size:14px}
  .center{text-align:center; display:flex; flex-direction:column; gap:12px; align-items:center}
  .big{font-size:28px; font-weight:800; margin:6px 0}
  .reveal{padding:14px 22px; border-radius:14px; background:linear-gradient(90deg, var(--accent-2), #c5f9e9); font-weight:900; border:0; cursor:pointer}
  .hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">

  <!-- SETUP -->
  <section id="setup" class="card">
    <h1 class="title">Secret Draw ‚Äî Country & Style</h1>
    <p class="subtitle">Enter two lists, one for countries and one for styles. Generate private links so each person gets a secret pair.</p>

    <label for="titleInput">Event title (optional)</label>
    <input id="titleInput" type="text" placeholder="e.g., Art Challenge 2025" />

    <label for="msgInput">Opening message (optional)</label>
    <input id="msgInput" type="text" placeholder="e.g., Click reveal to see your combo" />

    <label for="countriesInput">Countries (one per line)</label>
    <textarea id="countriesInput" placeholder="Japan&#10;Italy&#10;Brazil&#10;Mexico&#10;India"></textarea>

    <label for="stylesInput">Styles (one per line)</label>
    <textarea id="stylesInput" placeholder="Minimalist&#10;Baroque&#10;Futuristic&#10;Rustic&#10;Cyberpunk"></textarea>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="genBtn">Generate draw links</button>
    </div>
  </section>

  <!-- LINKS -->
  <section id="links" class="card hidden">
    <h2 class="title">Your draw links</h2>
    <p class="subtitle" id="linksSubtitle"></p>
    <div id="linksList" class="list"></div>
    <div class="row" style="margin-top:14px">
      <button class="btn secondary" id="backBtn">‚Üê Back</button>
      <button class="btn" id="copyAllBtn">Copy all links</button>
    </div>
  </section>

  <!-- DRAW -->
  <section id="draw" class="card hidden">
    <div class="center">
      <div id="drawTitlePill" class="tip">üé© Secret Draw</div>
      <h2 id="drawMsg" class="subtitle"></h2>
      <button id="revealBtn" class="reveal">Reveal my draw</button>
      <div id="result" class="hidden"></div>
      <button id="copyResultBtn" class="copy hidden">Copy my result</button>
      <p id="afterTip" class="tip"></p>
    </div>
  </section>

</div>

<script>
const $ = sel => document.querySelector(sel);
function toLines(s){ return s.split(/\r?\n/).map(x=>x.trim()).filter(Boolean); }
function shuffleInPlace(arr){
  for(let i=arr.length-1;i>0;i--){
    const r = new Uint32Array(1); crypto.getRandomValues(r);
    const j = r[0] % (i+1); [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function base64urlEncode(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replaceAll('+','-').replaceAll('/','_').replace(/=+$/,'');}
function base64urlDecode(str){str=str.replaceAll('-','+').replaceAll('_','/');while(str.length%4)str+='=';return Uint8Array.from(atob(str),c=>c.charCodeAt(0)).buffer;}
async function aesEncrypt(text){
  const enc=new TextEncoder().encode(text);
  const keyRaw=crypto.getRandomValues(new Uint8Array(32)),iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await crypto.subtle.importKey('raw',keyRaw,'AES-GCM',false,['encrypt','decrypt']);
  const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,enc);
  return {keyB64:base64urlEncode(keyRaw),ivB64:base64urlEncode(iv),ctB64:base64urlEncode(ct)};
}
async function aesDecrypt(keyB64,ivB64,ctB64){
  const keyRaw=base64urlDecode(keyB64),iv=new Uint8Array(base64urlDecode(ivB64));
  const key=await crypto.subtle.importKey('raw',keyRaw,'AES-GCM',false,['encrypt','decrypt']);
  const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,base64urlDecode(ctB64));
  return new TextDecoder().decode(pt);
}
function urlWithFragment(obj){
  return location.origin+location.pathname+'#'+base64urlEncode(new TextEncoder().encode(JSON.stringify(obj)));
}
function parseFragment(){
  if(!location.hash) return null;
  try{return JSON.parse(new TextDecoder().decode(base64urlDecode(location.hash.slice(1))));}catch{return null;}
}
function copy(text){ return navigator.clipboard.writeText(text); }

const genBtn=$('#genBtn'),backBtn=$('#backBtn'),copyAllBtn=$('#copyAllBtn');
const titleInput=$('#titleInput'),msgInput=$('#msgInput');
const countriesInput=$('#countriesInput'),stylesInput=$('#stylesInput');
const linksView=$('#links'),setupView=$('#setup'),drawView=$('#draw');
const linksList=$('#linksList'),linksSubtitle=$('#linksSubtitle');
const revealBtn=$('#revealBtn'),result=$('#result'),copyResultBtn=$('#copyResultBtn'),afterTip=$('#afterTip');

genBtn.addEventListener('click', async ()=>{
  const countries=toLines(countriesInput.value),styles=toLines(stylesInput.value);
  if(!countries.length||!styles.length){alert("Enter at least one country and one style");return;}
  if(countries.length!==styles.length){alert("Lists must have same length");return;}
  const title=titleInput.value.trim(),message=msgInput.value.trim();
  const shuffledC=shuffleInPlace(countries.slice()),shuffledS=shuffleInPlace(styles.slice());
  const payloads=[];
  for(let i=0;i<shuffledC.length;i++){
    const data={country:shuffledC[i],style:shuffledS[i]};
    const {keyB64,ivB64,ctB64}=await aesEncrypt(JSON.stringify(data));
    const link=urlWithFragment({v:1,mode:'reveal',title,message,iv:ivB64,ct:ctB64,k:keyB64});
    payloads.push({link});
  }
  setupView.classList.add('hidden'); linksView.classList.remove('hidden');
  linksList.innerHTML=''; linksSubtitle.textContent=`Created ${payloads.length} links. Share one per person.`;
  const all=[];
  payloads.forEach((p,i)=>{
    const row=document.createElement('div'); row.className='link-item';
    const lbl=document.createElement('div'); lbl.textContent=`Link ${i+1}`;
    const copyBtn=document.createElement('button'); copyBtn.className='copy'; copyBtn.textContent='Copy'; copyBtn.onclick=()=>copy(p.link);
    const open=document.createElement('a'); open.href=p.link; open.target='_blank'; open.textContent='Open'; open.className='btn secondary';
    row.append(lbl,copyBtn,open); linksList.append(row); all.push(p.link);
  });
  copyAllBtn.onclick=()=>copy(all.join('\n'));
});
backBtn.addEventListener('click',()=>{linksView.classList.add('hidden');setupView.classList.remove('hidden');});

async function initDraw(){
  const frag=parseFragment(); if(!frag||frag.mode!=='reveal') return;
  setupView.classList.add('hidden'); linksView.classList.add('hidden'); drawView.classList.remove('hidden');
  if(frag.title) $('#drawTitlePill').textContent='üé© '+frag.title;
  if(frag.message) $('#drawMsg').textContent=frag.message;
  let revealed=false;
  revealBtn.onclick=async ()=>{
    if(revealed) return; revealBtn.disabled=true; revealBtn.textContent='Decrypting...';
    try{
      const text=await aesDecrypt(frag.k,frag.iv,frag.ct);
      let obj={}; try{obj=JSON.parse(text);}catch{}
      result.innerHTML=`<div class="tip">Your Country:</div><div class="big">${obj.country||'?'}</div>
                        <div class="tip">Your Style:</div><div class="big">${obj.style||'?'}</div>`;
      result.classList.remove('hidden'); copyResultBtn.classList.remove('hidden');
      afterTip.textContent='Only you can see this. Do not share your link.';
    }catch{ alert('Invalid or broken link'); }
    revealBtn.classList.add('hidden'); revealed=true;
  };
  copyResultBtn.onclick=()=>{
    const t=[...result.querySelectorAll('.big')].map(e=>e.textContent).join(' ‚Äî ');
    copy(t).then(()=>{copyResultBtn.textContent='Copied!'; setTimeout(()=>copyResultBtn.textContent='Copy my result',1200);});
  };
}
initDraw();
</script>
</body>
</html>
